<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GPU Monitor</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace;
      background: #0d1117;
      color: #c9d1d9;
      line-height: 1.5;
      min-height: 100vh;
    }
    .header {
      background: #161b22;
      border-bottom: 1px solid #30363d;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }
    .header h1 { font-size: 20px; font-weight: 600; color: #f0f6fc; }
    .update-info { font-size: 13px; color: #8b949e; }
    .main { padding: 24px; }
    .loading, .error { text-align: center; padding: 48px; font-size: 16px; }
    .error { color: #f85149; }

    /* Two-column layout for all servers */
    .server-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
    }
    @media (max-width: 1200px) {
      .server-grid {
        grid-template-columns: 1fr;
      }
    }

    .server-card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      overflow: hidden;
    }
    .server-card.offline { opacity: 0.7; }
    .server-header {
      background: #21262d;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #30363d;
    }
    .server-title { display: flex; align-items: baseline; gap: 8px; flex-wrap: wrap; }
    .server-title h2 { font-size: 16px; font-weight: 600; color: #f0f6fc; }
    .hostname { font-size: 13px; color: #8b949e; }
    .status-badge {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 12px;
      font-weight: 500;
    }
    .status-badge.online { background: rgba(35, 134, 54, 0.2); color: #3fb950; }
    .status-badge.offline { background: rgba(248, 81, 73, 0.2); color: #f85149; }

    .system-metrics {
      padding: 12px 16px;
      border-bottom: 1px solid #30363d;
    }
    .metrics-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }
    .metrics-row:last-child { margin-bottom: 0; }
    .metric { display: flex; flex-direction: column; gap: 4px; }
    .metric-label {
      font-size: 11px;
      font-weight: 600;
      color: #8b949e;
      text-transform: uppercase;
    }
    .metric-value { font-size: 16px; font-weight: 600; color: #f0f6fc; }
    .metric-value.low { color: #3fb950; }
    .metric-value.medium { color: #f0883e; }
    .metric-value.high { color: #f85149; }
    .metric-detail { font-size: 11px; color: #8b949e; }
    .progress-bar {
      height: 4px;
      background: #30363d;
      border-radius: 2px;
      overflow: hidden;
      margin-top: 4px;
    }
    .progress-fill { height: 100%; border-radius: 2px; transition: width 0.3s ease; }

    .disks-section {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #30363d;
    }
    .disks-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
    }
    .disk-item {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 4px;
      padding: 8px 10px;
    }
    .disk-mount { font-size: 12px; font-weight: 600; color: #58a6ff; margin-bottom: 4px; }
    .disk-device { font-size: 10px; color: #8b949e; margin-bottom: 4px; }
    .disk-usage { font-size: 11px; color: #c9d1d9; }

    .gpu-section { padding: 12px 16px; }
    .section-title {
      font-size: 13px;
      font-weight: 600;
      color: #8b949e;
      margin-bottom: 12px;
      text-transform: uppercase;
    }
    .gpu-list { display: flex; flex-direction: column; gap: 8px; }
    .gpu-card {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 10px 12px;
    }
    .gpu-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
    .gpu-index { color: #58a6ff; font-weight: 600; }
    .gpu-name { color: #a371f7; font-weight: 500; flex: 1; }
    .driver-version { font-size: 11px; color: #8b949e; }
    .gpu-metrics { display: flex; gap: 16px; align-items: flex-start; flex-wrap: wrap; }
    .gpu-metric { display: flex; flex-direction: column; gap: 2px; }
    .gpu-metric.memory { flex: 1; min-width: 120px; }
    .gpu-metric-label { font-size: 10px; color: #8b949e; text-transform: uppercase; }
    .gpu-metric-value { font-size: 14px; font-weight: 600; }

    .processes { margin-top: 8px; padding-top: 8px; border-top: 1px solid #30363d; display: flex; flex-wrap: wrap; gap: 8px; }
    .process { font-size: 12px; }
    .process-user { color: #8b949e; }
    .process-cmd { color: #58a6ff; }
    .process-pid { color: #8b949e; }
    .process-mem { color: #f0883e; }

    .footer {
      background: #161b22;
      border-top: 1px solid #30363d;
      padding: 12px 24px;
      text-align: center;
      font-size: 12px;
      color: #8b949e;
    }

    /* Mobile responsive styles */
    @media (max-width: 480px) {
      .header {
        padding: 8px 12px;
        flex-direction: column;
        align-items: flex-start;
        gap: 2px;
      }
      .header h1 { font-size: 16px; }
      .update-info { font-size: 10px; }

      .main { padding: 0; }

      .server-grid { gap: 1px; }

      .server-card { border-radius: 0; border-left: none; border-right: none; }

      .server-header {
        padding: 8px 12px;
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }
      .server-title h2 { font-size: 14px; }
      .hostname { font-size: 11px; }
      .status-badge { font-size: 11px; }

      .system-metrics { padding: 8px 10px; }
      .metrics-row {
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      .metric-label { font-size: 10px; }
      .metric-value { font-size: 14px; }
      .metric-detail { font-size: 10px; }

      .disks-section { margin-top: 10px; padding-top: 10px; }
      .disks-grid {
        grid-template-columns: 1fr;
        gap: 6px;
      }
      .disk-item { padding: 6px 8px; }
      .disk-mount { font-size: 11px; }
      .disk-device { font-size: 9px; }
      .disk-usage { font-size: 10px; }

      .gpu-section { padding: 8px 10px; }
      .section-title { font-size: 11px; margin-bottom: 6px; }
      .gpu-list { gap: 4px; }
      .gpu-card { padding: 6px 8px; }
      .gpu-header { gap: 4px; margin-bottom: 6px; }
      .gpu-index { font-size: 12px; }
      .gpu-name { font-size: 12px; }
      .driver-version { font-size: 9px; }

      .gpu-metrics { gap: 12px; }
      .gpu-metric-label { font-size: 9px; }
      .gpu-metric-value { font-size: 12px; }
      .gpu-metric.memory { min-width: 100px; }

      .processes { gap: 6px; padding-top: 6px; margin-top: 6px; }
      .process { font-size: 10px; }

      .footer { padding: 6px 10px; font-size: 10px; }
    }

    /* Extra small phones */
    @media (max-width: 360px) {
      .header { padding: 6px 10px; }
      .header h1 { font-size: 14px; }
      .server-header { padding: 6px 10px; }
      .system-metrics { padding: 6px 10px; }
      .gpu-section { padding: 6px 10px; }
      .gpu-metrics {
        flex-direction: column;
        gap: 8px;
      }
      .gpu-metric.memory { width: 100%; }
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>GPU Monitor</h1>
    <div class="update-info" id="update-info">Loading...</div>
  </header>

  <main class="main">
    <div id="content" class="loading">Loading...</div>
  </main>

  <footer class="footer">
    <p>Auto-refresh: 30s | Data update: 1min | <span id="version">-</span></p>
  </footer>

  <script>
    const REFRESH_INTERVAL = 30000; // 30 seconds

    function formatBytes(bytes) {
      if (!bytes) return '0 B';
      const units = ['B', 'KB', 'MB', 'GB', 'TB'];
      let i = 0, value = bytes;
      while (value >= 1024 && i < units.length - 1) { value /= 1024; i++; }
      return `${value.toFixed(i > 1 ? 1 : 0)} ${units[i]}`;
    }

    function formatMemory(mb) {
      return mb >= 1024 ? `${(mb / 1024).toFixed(1)}G` : `${mb}M`;
    }

    function getUsageClass(percent) {
      if (percent >= 80) return 'high';
      if (percent >= 50) return 'medium';
      return 'low';
    }

    function getUsageColor(percent) {
      if (percent >= 80) return '#f85149';
      if (percent >= 50) return '#f0883e';
      return '#3fb950';
    }

    function getTempClass(temp) {
      if (temp >= 80) return 'high';
      if (temp >= 70) return 'medium';
      if (temp >= 50) return 'medium';
      return 'low';
    }

    // Filter out virtual/snap devices, keep real disks
    function filterDisks(disks) {
      return (disks || []).filter(d => {
        // Exclude loop devices (snap packages)
        if (d.device.startsWith('/dev/loop')) return false;
        // Exclude snap mounts
        if (d.mount_point.includes('/snap/')) return false;
        // Exclude boot/efi if small
        if (d.mount_point === '/boot/efi' && d.total_bytes < 2000000000) return false;
        return true;
      });
    }

    function renderServer(server) {
      const isOnline = server.status === 'online';

      let html = `
        <div class="server-card ${isOnline ? '' : 'offline'}">
          <div class="server-header">
            <div class="server-title">
              <h2>${server.name}</h2>
              <span class="hostname">(${server.hostname || server.host})</span>
            </div>
            <span class="status-badge ${server.status}">${server.status}</span>
          </div>
      `;

      if (isOnline && server.system) {
        const cpu = server.system.cpu || {};
        const mem = server.system.memory || {};
        const disks = filterDisks(server.system.disks);

        html += `
          <div class="system-metrics">
            <div class="metrics-row">
              <div class="metric">
                <span class="metric-label">CPU</span>
                <span class="metric-value ${getUsageClass(cpu.usage_percent)}">${cpu.usage_percent?.toFixed(1) || 0}%</span>
                <span class="metric-detail">${cpu.cores || 0} cores</span>
                <div class="progress-bar">
                  <div class="progress-fill" style="width: ${cpu.usage_percent || 0}%; background: ${getUsageColor(cpu.usage_percent)}"></div>
                </div>
              </div>
              <div class="metric">
                <span class="metric-label">Memory</span>
                <span class="metric-value ${getUsageClass(mem.usage_percent)}">${formatBytes(mem.used_bytes)}</span>
                <span class="metric-detail">/ ${formatBytes(mem.total_bytes)} (${mem.usage_percent?.toFixed(1) || 0}%)</span>
                <div class="progress-bar">
                  <div class="progress-fill" style="width: ${mem.usage_percent || 0}%; background: ${getUsageColor(mem.usage_percent)}"></div>
                </div>
              </div>
            </div>
            ${disks.length > 0 ? `
              <div class="disks-section">
                <span class="metric-label">Disks (${disks.length})</span>
                <div class="disks-grid">
                  ${disks.map(d => `
                    <div class="disk-item">
                      <div class="disk-mount">${d.mount_point}</div>
                      <div class="disk-device">${d.device}</div>
                      <div class="disk-usage">${formatBytes(d.used_bytes)} / ${formatBytes(d.total_bytes)} (${d.usage_percent?.toFixed(1)}%)</div>
                      <div class="progress-bar">
                        <div class="progress-fill" style="width: ${d.usage_percent}%; background: ${getUsageColor(d.usage_percent)}"></div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        `;

        if (server.gpus && server.gpus.length > 0) {
          html += `
            <div class="gpu-section">
              <h3 class="section-title">GPUs (${server.gpus.length})</h3>
              <div class="gpu-list">
                ${server.gpus.map(gpu => `
                  <div class="gpu-card">
                    <div class="gpu-header">
                      <span class="gpu-index">[${gpu.index}]</span>
                      <span class="gpu-name">${gpu.name}</span>
                      <span class="driver-version">${gpu.driver_version}</span>
                    </div>
                    <div class="gpu-metrics">
                      <div class="gpu-metric">
                        <span class="gpu-metric-label">Temp</span>
                        <span class="gpu-metric-value ${getTempClass(gpu.temperature_celsius)}">${gpu.temperature_celsius}'C</span>
                      </div>
                      <div class="gpu-metric">
                        <span class="gpu-metric-label">GPU</span>
                        <span class="gpu-metric-value ${gpu.utilization_percent > 10 ? 'low' : ''}">${gpu.utilization_percent}%</span>
                      </div>
                      <div class="gpu-metric memory">
                        <span class="gpu-metric-label">VRAM</span>
                        <span class="gpu-metric-value">${formatMemory(gpu.memory.used_mb)} / ${formatMemory(gpu.memory.total_mb)}</span>
                        <div class="progress-bar">
                          <div class="progress-fill" style="width: ${gpu.memory.usage_percent}%; background: #a371f7"></div>
                        </div>
                      </div>
                    </div>
                    ${gpu.processes && gpu.processes.length > 0 ? `
                      <div class="processes">
                        ${gpu.processes.map(p => `
                          <span class="process">
                            <span class="process-user">${p.user}:</span><span class="process-cmd">${p.command}</span><span class="process-pid">/${p.pid}</span><span class="process-mem">(${p.gpu_memory_mb}M)</span>
                          </span>
                        `).join(' ')}
                      </div>
                    ` : ''}
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }
      } else if (!isOnline) {
        html += `<div style="padding: 24px 16px; color: #f85149;">${server.error_message || 'Connection failed'}</div>`;
      }

      html += '</div>';
      return html;
    }

    function sortServers(servers) {
      // Sort: node0 first, then node1, then others
      return servers.sort((a, b) => {
        const aName = a.name.toLowerCase();
        const bName = b.name.toLowerCase();
        // DDC nodes first
        const aIsDDC = aName.includes('ddc');
        const bIsDDC = bName.includes('ddc');
        if (aIsDDC && !bIsDDC) return -1;
        if (!aIsDDC && bIsDDC) return 1;
        // node0 before node1
        const aNode = aName.match(/node\s*(\d+)/)?.[1] || '99';
        const bNode = bName.match(/node\s*(\d+)/)?.[1] || '99';
        return parseInt(aNode) - parseInt(bNode);
      });
    }

    async function fetchData() {
      try {
        const res = await fetch(`data/status.json?t=${Date.now()}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        document.getElementById('update-info').textContent =
          `Last updated: ${new Date(data.timestamp).toLocaleString()}`;
        document.getElementById('version').textContent =
          `Version: ${data.collector_version || '-'}`;

        if (data.servers && data.servers.length > 0) {
          const sorted = sortServers([...data.servers]);
          const html = `<div class="server-grid">${sorted.map(renderServer).join('')}</div>`;
          document.getElementById('content').innerHTML = html;
        } else {
          document.getElementById('content').innerHTML = '<div class="loading">No servers configured</div>';
        }
      } catch (e) {
        document.getElementById('content').innerHTML = `<div class="error">Failed to load: ${e.message}</div>`;
      }
    }

    fetchData();
    setInterval(fetchData, REFRESH_INTERVAL);
  </script>
</body>
</html>
