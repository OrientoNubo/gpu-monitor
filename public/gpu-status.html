<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPU Status Monitor</title>
    <style>
        body {
            font-family: monospace;
            background-color: #000000;
            color: #AAAAAA;
            padding: 0;
            margin: 0;
            font-size: 14px;
            line-height: 1.3;
        }
        n you
        #status {
            white-space: pre;
            padding: 10px;
            margin: 0;
        }
        
        /* 服务器名称行 */
        .server-line { color: #AAAAAA; }
        
        /* GPU 各部分颜色 */
        .gpu-index { color: #00AAAA; }
        .gpu-name { color: #bd5eb5; }
        .temp-low { color: #BF0000; }
        .temp-high { color: #FF5555; }
        .util-low { color: #00AA00; }
        .util-high { color: #55FF55; }
        .mem-used { color: #bfbf43; }
        .mem-total { color: #a3782f; }
        .user { color: #B5B5B5; }
        .program { color: #00AAAA; }
        .mem-process { color: #D09634; }
        
        .loading { color: #AAAAAA; padding: 20px; }
    </style>
</head>
<body>
    <pre id="status" class="loading">Loading...</pre>
    
    <script>
        const REFRESH_INTERVAL = 10000;
        
        function colorizeText(text) {
            const lines = text.split('\n');
            let html = '';
            
            for (let line of lines) {
                if (!line.trim()) {
                    html += '\n';
                    continue;
                }
                
                // 服务器信息行
                if (!line.includes('[')) {
                    html += `<span class="server-line">${escapeHtml(line)}</span>\n`;
                    continue;
                }
                
                // GPU 信息行
                html += parseGPULine(line) + '\n';
            }
            
            return html;
        }
        
        function parseGPULine(line) {
            let result = '';
            let pos = 0;
            
            // 1. GPU 索引 [0]
            const indexMatch = line.match(/^(\[\d+\])\s*/);
            if (indexMatch) {
                result += `<span class="gpu-index">${escapeHtml(indexMatch[1])}</span>`;
                // 保留空格
                result += escapeHtml(line.substring(indexMatch[1].length, indexMatch[0].length));
                pos = indexMatch[0].length;
            }
            
            // 2. GPU 名称（到 | 为止）
            const pipePos = line.indexOf('|', pos);
            if (pipePos > pos) {
                const namePart = line.substring(pos, pipePos);
                result += `<span class="gpu-name">${escapeHtml(namePart)}</span>`;
                result += '|';
                pos = pipePos + 1;
            }
            
            // 3. 温度和使用率部分
            // 匹配: " 67'C,  95 % |" - 保留所有空格
            const tempUtilMatch = line.substring(pos).match(/^(\s*)(\d+)'C,(\s*)(\d+)(\s*)%(\s*)\|/);
            if (tempUtilMatch) {
                const [full, space1, temp, space2, util, space3, space4] = tempUtilMatch;
                const tempNum = parseInt(temp);
                const utilNum = parseInt(util);
                
                result += space1; // 前导空格
                
                // 温度
                if (tempNum >= 50) {
                    result += `<span class="temp-high">${temp}'C</span>`;
                } else {
                    result += `<span class="temp-low">${temp}'C</span>`;
                }
                
                result += ',' + space2; // 逗号后的空格
                
                // 使用率
                if (utilNum > 10) {
                    result += `<span class="util-high">${util}</span>`;
                } else {
                    result += `<span class="util-low">${util}</span>`;
                }
                
                result += space3 + '%' + space4 + '|';
                pos += full.length;
            }
            
            // 4. 内存部分
            // 匹配: " 15881 / 24576 MB |" - 保留所有空格
            const memMatch = line.substring(pos).match(/^(\s*)(\d+)(\s*)\/(\s*)(\d+)(\s+)MB(\s*)\|/);
            if (memMatch) {
                const [full, space1, used, space2, slash, total, space3, space4] = memMatch;
                
                result += space1; // 前导空格
                result += `<span class="mem-used">${used}</span>`;
                result += space2 + '/' + slash; // 中间空格和斜杠
                result += `<span class="mem-total">${total}${space3}MB</span>`;
                result += space4 + '|';
                pos += full.length;
            }
            
            // 5. 进程部分
            const remaining = line.substring(pos);
            if (remaining.trim()) {
                result += parseProcesses(remaining);
            }
            
            return result;
        }
        
        function parseProcesses(text) {
            let result = '';
            const processPattern = /(\w+):(\w+)\/(\d+)\((\d+)M?\)/g;
            let lastIndex = 0;
            let match;
            
            while ((match = processPattern.exec(text)) !== null) {
                // 保留匹配之前的文本（包括空格）
                if (match.index > lastIndex) {
                    result += escapeHtml(text.slice(lastIndex, match.index));
                }
                
                const [full, username, program, pid, memory] = match;
                
                result += `<span class="user">${escapeHtml(username)}</span>:`;
                result += `<span class="program">${escapeHtml(program)}</span>`;
                result += `/${pid}(`;
                result += `<span class="mem-process">${memory}M</span>`;
                result += ')';
                
                lastIndex = processPattern.lastIndex;
            }
            
            // 添加剩余文本
            if (lastIndex < text.length) {
                result += escapeHtml(text.slice(lastIndex));
            }
            
            return result;
        }
        
        function escapeHtml(text) {
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;')
                .replace(/ /g, '&nbsp;');  // 关键：保留空格
        }
        
        function updateStatus() {
            fetch('gpu-status.txt?t=' + new Date().getTime())
                .then(response => response.text())
                .then(data => {
                    const statusElement = document.getElementById('status');
                    if (data.trim()) {
                        statusElement.innerHTML = colorizeText(data);
                    } else {
                        statusElement.innerHTML = '<span class="loading">No data</span>';
                    }
                })
                .catch(error => {
                    document.getElementById('status').innerHTML = 
                        `<span style="color:#FF5555">Error: ${error.message}</span>`;
                });
        }
        
        updateStatus();
        setInterval(updateStatus, REFRESH_INTERVAL);
    </script>
</body>
</html>